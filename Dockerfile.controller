# Clusterio Controller - Standalone Installation
# This container runs the Clusterio controller (web UI, API, cluster coordination)
FROM node:24-bookworm-slim

# OCI Image Labels
LABEL org.opencontainers.image.source="https://github.com/solarcloud7/clusterio-docker" \
      org.opencontainers.image.title="Clusterio Controller" \
      org.opencontainers.image.description="Clusterio cluster controller with web UI and API" \
      org.opencontainers.image.licenses="MIT" \
      org.opencontainers.image.vendor="solarcloud7"

# Build arguments for controller configuration
ARG CONTROLLER_HTTP_PORT=8080

# Environment variables (can be overridden at runtime)
ENV CONTROLLER_HTTP_PORT=${CONTROLLER_HTTP_PORT} \
    NODE_ENV=production \
    NODE_OPTIONS=--no-deprecation \
    NPM_CONFIG_UPDATE_NOTIFIER=false \
    CLUSTERIO_SUPPRESS_DEV_WARNING=1

# Install OS dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates \
    curl \
    python3 \
    gosu \
 && rm -rf /var/lib/apt/lists/*

# Create clusterio user and directory
RUN useradd -m -s /bin/bash clusterio && \
    mkdir -p /clusterio && \
    chown clusterio:clusterio /clusterio

WORKDIR /clusterio

# Switch to clusterio user for npm install
USER clusterio

# Install Clusterio controller package and plugins
RUN npm install --omit=dev \
    @clusterio/controller \
    @clusterio/ctl \
    @clusterio/plugin-global_chat \
    @clusterio/plugin-inventory_sync \
    @clusterio/plugin-player_auth \
    @clusterio/plugin-research_sync \
    @clusterio/plugin-statistics_exporter \
    @clusterio/plugin-subspace_storage

# Suppress the development warning banner
COPY --chown=clusterio:clusterio scripts/suppress-dev-warning.js /tmp/suppress-dev-warning.js
RUN node /tmp/suppress-dev-warning.js && rm /tmp/suppress-dev-warning.js

# Note: Controller config is set at runtime in entrypoint to persist in volume

# Expose the controller port
EXPOSE ${CONTROLLER_HTTP_PORT}

# Switch back to root for entrypoint (gosu will drop to clusterio)
USER root

COPY --chmod=755 scripts/install-plugins.sh /scripts/install-plugins.sh
COPY --chmod=755 scripts/seed-mods.sh /scripts/seed-mods.sh
COPY --chmod=755 scripts/seed-instances.sh /scripts/seed-instances.sh
COPY --chmod=755 scripts/controller-entrypoint.sh /controller-entrypoint.sh

HEALTHCHECK --interval=10s --timeout=3s --start-period=30s --retries=6 \
  CMD curl -sf http://localhost:${CONTROLLER_HTTP_PORT:-8080}/ || exit 1

ENTRYPOINT ["/controller-entrypoint.sh"]
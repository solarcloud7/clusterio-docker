# ============================================================================
# Clusterio Docker Compose Configuration
# ============================================================================
# To add more hosts:
#   1. Increment HOST_COUNT in controller environment
#   2. Copy a host service block and change:
#      - Service name: clusterio-host-N (N = host number)
#      - container_name & hostname: clusterio-host-N
#      - HOST_NAME: clusterio-host-N (MUST match for auto-token loading)
#      - Ports: 34N00-34N09:34N00-34N09/udp
#      - Volumes: host-N-instances, host-N-logs
#   3. Add corresponding volumes at the bottom
#
# IMPORTANT: Host names MUST follow the pattern "clusterio-host-N" for
# automatic token loading. The host extracts its ID from the name.
# ============================================================================

# Template anchor for host services (reduces duplication)
x-host-base: &host-base
  build:
    context: .
    dockerfile: Dockerfile.host
    args:
      FACTORIO_HEADLESS_TAG: ${FACTORIO_HEADLESS_TAG:-stable}
      CONTROLLER_URL: ${CONTROLLER_URL:-http://clusterio-controller:8080/}
  env_file:
    - env/host.env
  networks:
    - clusterio-net
  depends_on:
    clusterio-controller:
      condition: service_healthy
  restart: unless-stopped

services:
  clusterio-controller:
    build:
      context: .
      dockerfile: Dockerfile.controller
      args:
        INIT_CLUSTERIO_ADMIN: ${INIT_CLUSTERIO_ADMIN}
        CONTROLLER_HTTP_PORT: ${CONTROLLER_HTTP_PORT:-8080}
        CONTROLLER_PUBLIC_ADDRESS: ${CONTROLLER_PUBLIC_ADDRESS:-http://localhost:8080/}
    env_file:
      - env/controller.env
    container_name: clusterio-controller
    hostname: clusterio-controller
    ports:
      - "${CONTROLLER_HTTP_PORT:-8080}:${CONTROLLER_HTTP_PORT:-8080}"
    volumes:
      - controller-database:/clusterio/database
      - controller-mods:/clusterio/mods
      - controller-logs:/clusterio/logs
      - shared-tokens:/clusterio/tokens
    environment:
      - CLUSTERIO_ADMIN=${CLUSTERIO_ADMIN:-admin}
      - HOST_COUNT=${HOST_COUNT:-2}
    networks:
      - clusterio-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${CONTROLLER_HTTP_PORT:-8080}/"]
      interval: 5s
      timeout: 3s
      retries: 12
      start_period: 10s

  # -------------------------------------------------------------------------
  # Host 1 - Port range 34100-34199
  # -------------------------------------------------------------------------
  clusterio-host-1:
    <<: *host-base
    container_name: clusterio-host-1
    hostname: clusterio-host-1
    environment:
      - HOST_NAME=clusterio-host-1
    ports:
      - "34100-34109:34100-34109/udp"
    volumes:
      - host-1-instances:/clusterio/instances
      - host-1-logs:/clusterio/logs
      - shared-tokens:/clusterio/tokens:ro

  # -------------------------------------------------------------------------
  # Host 2 - Port range 34200-34299
  # -------------------------------------------------------------------------
  clusterio-host-2:
    <<: *host-base
    container_name: clusterio-host-2
    hostname: clusterio-host-2
    environment:
      - HOST_NAME=clusterio-host-2
    ports:
      - "34200-34209:34200-34209/udp"
    volumes:
      - host-2-instances:/clusterio/instances
      - host-2-logs:/clusterio/logs
      - shared-tokens:/clusterio/tokens:ro

  # -------------------------------------------------------------------------
  # To add Host 3, uncomment and adjust:
  # -------------------------------------------------------------------------
  # clusterio-host-3:
  #   <<: *host-base
  #   container_name: clusterio-host-3
  #   hostname: clusterio-host-3
  #   environment:
  #     - HOST_NAME=clusterio-host-3
  #   ports:
  #     - "34300-34309:34300-34309/udp"
  #   volumes:
  #     - host-3-instances:/clusterio/instances
  #     - host-3-logs:/clusterio/logs
  #     - shared-tokens:/clusterio/tokens:ro

networks:
  clusterio-net:
    driver: bridge

volumes:
  # Controller volumes
  controller-database:
  controller-mods:
  controller-logs:
  
  # Host 1 volumes
  host-1-instances:
  host-1-logs:

  # Host 2 volumes
  host-2-instances:
  host-2-logs:

  # Host 3 volumes (uncomment when adding host 3)
  # host-3-instances:
  # host-3-logs:

  # Shared
  shared-tokens:
  
# ============================================================================
# Clusterio Docker Compose Configuration
# ============================================================================
# To add more hosts:
#   1. Increment HOST_COUNT in controller environment
#   2. Copy a host service block and change:
#      - Service name: clusterio-host-N (N = host number)
#      - container_name & hostname: clusterio-host-N
#      - HOST_NAME: clusterio-host-N (MUST match for auto-token loading)
#      - Ports: 34N00-34N09:34N00-34N09/udp
#      - Volume: host-N-data
#   3. Add host-N-data volume at the bottom
#   4. Include the seed-mods mount: ./seed-data/mods:/clusterio/seed-mods:ro
#
# IMPORTANT: Host names MUST follow the pattern "clusterio-host-N" for
# automatic token loading. The host extracts its ID from the name.
# ============================================================================

# Template anchor for host services (reduces duplication)
x-host-base: &host-base
  build:
    context: .
    dockerfile: Dockerfile.host
    args:
      FACTORIO_HEADLESS_TAG: ${FACTORIO_HEADLESS_TAG:-stable}
      # FACTORIO_HEADLESS_SHA256: ${FACTORIO_HEADLESS_SHA256:-}
      # CURL_RETRIES: ${CURL_RETRIES:-8}
      # Optional: install the full Factorio game client for graphical asset export.
      # When enabled, Clusterio's "export-data" flow can produce complete item
      # spritesheets with icons. Requires a valid Factorio account.
      #
      # SECURITY: build args may appear in `docker history`. For production,
      # use BuildKit secrets instead (see Dockerfile.host comments).
      #
      # INSTALL_FACTORIO_CLIENT: "true"
      # FACTORIO_CLIENT_BUILD: "alpha"      # "alpha" = base game, "expansion" = Space Age
      # FACTORIO_CLIENT_TAG: stable
      # FACTORIO_CLIENT_USERNAME: "${FACTORIO_USERNAME}"
      # FACTORIO_CLIENT_TOKEN: "${FACTORIO_TOKEN}"
  env_file:
    - .env
  networks:
    - clusterio-net
  depends_on:
    clusterio-controller:
      condition: service_healthy
  restart: unless-stopped
  # To use external plugins, add to each host's volumes:
  # - ./plugins:/clusterio/external_plugins

services:
  clusterio-controller:
    build:
      context: .
      dockerfile: Dockerfile.controller
      args:
        CONTROLLER_HTTP_PORT: ${CONTROLLER_HTTP_PORT:-8080}
    env_file:
      - .env
    container_name: clusterio-controller
    hostname: clusterio-controller
    ports:
      - "${CONTROLLER_HTTP_PORT:-8080}:${CONTROLLER_HTTP_PORT:-8080}"
    volumes:
      - controller-data:/clusterio/data
      - shared-tokens:/clusterio/tokens
      - ./seed-data:/clusterio/seed-data:ro         # Seed instances on first run
      # - ./plugins:/clusterio/external_plugins  # Uncomment for external plugins
    environment:
      - HOST_COUNT=${HOST_COUNT:-2}
    networks:
      - clusterio-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:${CONTROLLER_HTTP_PORT:-8080}/"]
      interval: 10s
      timeout: 3s
      retries: 6
      start_period: 30s

  # -------------------------------------------------------------------------
  # Host 1 - Port range 34100-34199 - Full game client (graphical asset export)
  # -------------------------------------------------------------------------
  clusterio-host-1:
    <<: *host-base
    build:
      context: .
      dockerfile: Dockerfile.host
      args:
        FACTORIO_HEADLESS_TAG: ${FACTORIO_HEADLESS_TAG:-stable}
        INSTALL_FACTORIO_CLIENT: ${INSTALL_FACTORIO_CLIENT:-true}
        FACTORIO_CLIENT_BUILD: ${FACTORIO_CLIENT_BUILD:-expansion}
        FACTORIO_CLIENT_TAG: ${FACTORIO_CLIENT_TAG:-stable}
        FACTORIO_CLIENT_USERNAME: ${FACTORIO_USERNAME}
        FACTORIO_CLIENT_TOKEN: ${FACTORIO_TOKEN}
        # FACTORIO_CLIENT_SHA256: ${FACTORIO_CLIENT_SHA256:-}
    container_name: clusterio-host-1
    hostname: clusterio-host-1
    environment:
      - HOST_NAME=clusterio-host-1
    ports:
      - "34100-34109:34100-34109/udp"
    volumes:
      - host-1-data:/clusterio/data
      - factorio-client:/opt/factorio-client
      - shared-tokens:/clusterio/tokens:ro
      - ./seed-data/mods:/clusterio/seed-mods:ro

  # -------------------------------------------------------------------------
  # Host 2 - Port range 34200-34299 (headless only, no game client)
  # -------------------------------------------------------------------------
  clusterio-host-2:
    <<: *host-base
    container_name: clusterio-host-2
    hostname: clusterio-host-2
    environment:
      - HOST_NAME=clusterio-host-2
      - SKIP_CLIENT=true
    ports:
      - "34200-34209:34200-34209/udp"
    volumes:
      - host-2-data:/clusterio/data
      - shared-tokens:/clusterio/tokens:ro
      - ./seed-data/mods:/clusterio/seed-mods:ro

  # -------------------------------------------------------------------------
  # Prometheus - Metrics collection (optional)
  # -------------------------------------------------------------------------
  # prometheus:
  #   image: prom/prometheus
  #   container_name: clusterio-prometheus
  #   hostname: prometheus
  #   volumes:
  #     - ./scripts/prometheus.yml:/etc/prometheus/prometheus.yml:ro
  #     - prometheus-data:/prometheus
  #   ports:
  #     - "9090:9090"
  #   networks:
  #     - clusterio-net
  #   depends_on:
  #     - clusterio-controller
  #   restart: unless-stopped

networks:
  clusterio-net:
    driver: bridge

volumes:
  controller-data:    # All controller persistent data
  host-1-data:        # Host 1 persistent data (config, instances, logs)
  host-2-data:        # Host 2 persistent data
  prometheus-data:    # Prometheus metrics storage
  shared-tokens:      # Token exchange between controller and hosts
  factorio-client:    # Factorio game client (persists across `down -v`)
    external: true
  